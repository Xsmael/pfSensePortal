

Quick / default isnstallation of pfSense
i386 vs amd64 bit
might be necessary to disable ACPI via boot option (2) - https://doc.pfsense.org/index.php/Booting_Options#pfSense_2.0
might be necessary to enable boot from USB drive via boot option (3) - https://doc.pfsense.org/index.php/Boot_Troubleshooting#Booting_from_USB

When booting from LiveCD stops in the middle (or stop with a mount error as here https://doc.pfsense.org/index.php/Boot_Troubleshooting), choose 'Boot from USB drive (option 3) at the first pfSense selection screen
(press I at the beginning of the boot process when asked for input to invoke the installation, otherwise it will start the LiveCD after 10 seconds)
(remove CD after installation, otherwise it boots up again from the CD instead of the newly created installation on the hard disk)
configure network interface em0 as WAN (172.16.1.X/24) and em1 as LAN (IP 192.168.1.1/24 with DHCP services enabled)
connect with a cable to the LAN port, wait until your computer receives an IP address from the pfSense and open the web borwser pointing to http://192.168.1.1
finish the installation process by following the instructions of the wizard

enable remote access on WAN interface for SSH, web management and ICMP pings through Firewall rules

Admin advanced
Activate HTTPS for WebConfigurator
Enable SSH (Secure Shell)

Login with SSH as root and run these statement in the shell (to get to the shell press 8)
# for AMD64 used 
#setenv PACKAGESITE ftp://ftp-archive.freebsd.org/pub/FreeBSD-Archive/ports/amd64/packages-8.3-release/Latest/
# for i386 use
setenv PACKAGESITE ftp://ftp-archive.freebsd.org/pub/FreeBSD-Archive/ports/i386/packages-8.3-release/Latest/
pkg_add -r curl
pkg_add -r wget
pkg_add -r bash
pkg_add -r python
pkg_add -r git
pkg_add -r p5-Net-SMTP-TLS

now reboot the system

cd /home
git clone https://github.com/x-ian/pfSensePortal.git
ln -s /usr/local/bin/bash /bin/bash
cp /home/pfSensePortal/config.txt.sample /home/pfSensePortal/config.txt
and adjust values as needed
cp /home/pfSensePortal/config_gmail.txt.sample /home/pfSensePortal/config_gmail.txt
and adjust values as needed

mkdir /home/local_backup_sequences

pfSense config
Create and enable new Captive portal zone on the internal LAN interfaces
Configure RADIUS server with RADIUS authentication
Set IP of primary RADIUS server to the daloRADIUS server
enabled 'send RADIUS accounting packets' with 'interim updates'
enable 'RADIUS MAC authentication'
set 'MAC authentication secret' to radius
enable 'Use RADIUS Session-Timeout attributes'
MAC address format 'unformatted'
Choose file 'setup-captiveportal/captiveportal-apzu_portal_page.html' for 'Portal page content'
Choose file 'setup-captiveportal/captiveportal-apzu_portal_error_page.html' for 'Authentication error page contents'
disable concurrent logins
add 172.16.1.0 as allowed IP addresses (to bypass captiv portal registration and traffic accounting for local servers)
add pih.org, email.pih.org, owa.pih.org, exch2007pih.pih.org as allowed hostname


upload all files from directory pfSensePort/setup-captiveportal/filemanager through captive portal - file manager

install 'freeradius2' from 'system - packages - available packages'
stop service freeradius from status - services

add vlan interfaces to em1 starting from 192.168.11.x upwards
disable LAN (em1) interface
configure DHCP server for every VLAN interface
add a default firewall rule for every VLAN interface allowing any protocol to pass
(might need to configure the VLAN IP as the local DNS server within the DHCP server of every VLAN interface)

for the capitve portal enable all VLAN interfaces

add these line to root crontab

@reboot /home/pfSensePortal/send_gmail_after_startup.sh
55 23 * * Sun /home/pfSensePortal/misc/weekly_maintenance.sh
5 7 * * * /home/pfSensePortal/misc/monitor_network_devices.sh

copy private SSH key id_rsa for system dev.pih-emr.org to /root/.ssh

configure pfSense emailing
Go to System - Advanced - Notifications and enter
E-Mail server: smtp.gmail.com
SMTP Port of E-Mail server: 465
Secure SMTP Connection	Enable SMTP over SSL/TLS
Enable STARTTLS
From e-mail address: mail@apzu.pih.org
Notification E-Mail address: apzu-it@apzu.pih.org
Notification E-Mail auth username (optional): mail@apzu.pih.org	
Notification E-Mail auth password: <specify password here>
Add 'Weekly Network Utilization' under Status - Email Reports with settings
weekly, on Sunday at 23:00
with RRD Graphs captive portal :: concurrent and a weekly time span and RRD Graph WAN :: Traffic



installing packages
ntop
- add firewall rules on wan interface to allow traffic on port 3000

posibly increase intervall of interim updates from pfSense NAS to radius server: https://redmine.pfsense.org/issues/1492


when temporarily deactivating a network interface pfSense needs to be rebooted

daloradius
reboot after adding new NAS
	# checking for concurrently active users of same user group / profile
	# copy/paste into daloradius /etc/freeradius/sites-enabled/default
	# below the counterChilliSpot entries
	if ("%{check:Lucent-Max-Shared-Users}") {
		if("%{check:Lucent-Max-Shared-Users}" <= "%{sql:select count(*) from radacct where acctstoptime is null and username in (select username from radusergroup where groupname in (select groupname from radusergroup where username='%{User-Name}'));}") {
			update reply {
				Reply-Message := "Too many users - please try again later (%{sql:select count(*) from radacct where acctstoptime is null and username in (select username from radusergroup where groupname in (select groupname from radusergroup where username='%{User-Name}'))} of %{check:Lucent-Max-Shared-Users})"
			}
			reject
		}
	}
run dpkg-reconfigure tzdata from command line as root and set timezone