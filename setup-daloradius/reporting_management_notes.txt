# snipplets for reporting and statistics

# get number of unique devices being blocked because of data volume limit
grep "\- 3 \-" /tmp/check_device_status.log | awk -F'-' '{print $1}' | sort -u

# get number of unique device newly being registered
grep "\- x \-" /tmp/check_device_status.log | awk -F'-' '{print $1}' | sort -u


reset volume counter for a system
big TODO: only reset todays counter
disconnect pfsense sessions
select * from radacct where username = '74e543363a76';
update radacct set acctinputoctets = 0 where username = '74e543363a76';
update radacct set acctoutputoctets = 0 where username = 'c417fe96167d';


# devices registered in period
set @startday = '2014-10-24';
set @endday = '2014-10-27'; # including
# by group
SELECT radusergroup.groupname, count(distinct(radcheck.username)) FROM radcheck LEFT JOIN radusergroup ON radcheck.username=radusergroup.username LEFT JOIN userinfo ON radcheck.username=userinfo.username where creationdate > @startday and creationdate <  date(date_add(@endday, INTERVAL +1 DAY)) GROUP by radusergroup.groupname;
# breakdown
SELECT distinct(radcheck.username),radusergroup.groupname as groupname, userinfo.lastname, userinfo.email, userinfo.company, userinfo.address, userinfo.city  FROM radcheck LEFT JOIN radusergroup ON radcheck.username=radusergroup.username LEFT JOIN userinfo ON radcheck.username=userinfo.username where creationdate > @startday and creationdate <  date(date_add(@endday, INTERVAL +1 DAY)) GROUP by radcheck.Username order by groupname;


# devices ever registered
# by group
SELECT radusergroup.groupname, count(distinct(radcheck.username)) FROM radcheck LEFT JOIN radusergroup ON radcheck.username=radusergroup.username LEFT JOIN userinfo ON radcheck.username=userinfo.username where creationdate < date_add(@endday, INTERVAL +1 DAY) GROUP by radusergroup.groupname order by groupname;
# breakdown
SELECT distinct(radcheck.username),radusergroup.groupname as groupname, userinfo.lastname, userinfo.email, userinfo.company, userinfo.address, userinfo.city, userinfo.creationdate  FROM radcheck LEFT JOIN radusergroup ON radcheck.username=radusergroup.username LEFT JOIN userinfo ON radcheck.username=userinfo.username GROUP by radcheck.Username order by groupname;


# devices active in period 
set @startday = '2014-10-26';
set @endday = '2014-10-27'; # including
# by group
select radusergroup.groupname, count(distinct(radacct.username)) from radacct left join  radusergroup ON radacct.username=radusergroup.username where  ((acctstarttime < date(date_add(@endday, INTERVAL +1 DAY)) and acctstoptime > @startday) or (acctstarttime < date(date_add(@endday, INTERVAL +1 DAY)) and acctstoptime is null)) group by groupname;
# breakdown
select (distinct(username)), groupname from radacct where  ((acctstarttime < date(date_add(@endday, INTERVAL +1 DAY)) and acctstoptime > @startday) or (acctstarttime < date(date_add(@endday, INTERVAL +1 DAY)) and acctstoptime is null)) group by groupname;


# attributes per group
select groupname, attribute, value from radgroupcheck order by groupname;

select groupname, 
  (select value from radgroupcheck r2 where attribute='Lucent-Max-Shared-Users' and r2.groupname = r1.groupname)  'Max Concurrent Users', 
  (select (value/1000000) from radgroupcheck r5 where attribute='CS-Output-Octets-Daily' and r5.groupname = r1.groupname)  'Max Daily Down', 
  (select (value/1000000) from radgroupcheck r6 where attribute='CS-Input-Octets-Daily' and r6.groupname = r1.groupname)  'Max Daily Up', 
  (select (value/1000000) from radgroupcheck r7 where attribute='CS-Output-Octets-Weekly' and r7.groupname = r1.groupname)  'Max Weekly Down',
  (select (value/1000000) from radgroupcheck r8 where attribute='CS-Input-Octets-Weekly' and r8.groupname = r1.groupname)  'Max Weekly Up'
from radgroupcheck r1 group by groupname;

select groupname, 
  (select value from radgroupreply r3 where attribute='WISPr-Bandwidth-Max-Up' and r3.groupname = r1.groupname)  'Max Bandwidth Up',
  (select value from radgroupreply r4 where attribute='WISPr-Bandwidth-Max-Down' and r4.groupname = r1.groupname)  'Max Bandwidth Down', 
  ((select (value/1000000) from radgroupreply r5 where attribute='Session-Timeout' and r5.groupname = r1.groupname) * 1000000 / 3600)  'Session Timeout (h)'
from radgroupreply r1 group by groupname;


# top users
set @startday = '2014-10-28';
set @endday = '2014-10-28'; # including
SELECT distinct(radacct.UserName), radusergroup.groupname, userinfo.lastname, userinfo.email, userinfo.company, userinfo.address, userinfo.city, (sum(radacct.AcctOutputOctets)/1000000) as Download FROM radacct     LEFT JOIN radusergroup ON radacct.username=radusergroup.username LEFT JOIN userinfo ON radacct.username=userinfo.username    WHERE (AcctStopTime > '0000-00-00 00:00:01' AND AcctStartTime>@startday AND AcctStartTime<date(date_add(@endday, INTERVAL +1 DAY))) OR ((radacct.AcctStopTime IS NULL OR radacct.AcctStopTime = '0000-00-00 00:00:00') AND AcctStartTime<date(date_add(@endday, INTERVAL +1 DAY))) group by UserName order by download desc limit 5;
